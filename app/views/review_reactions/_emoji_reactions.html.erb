<div id="emoji-reactions-<%= user_rating.id %>" class="mt-3 pt-3 border-t border-neutral-100">
  <% user_reactions = logged_in? ? current_user.review_reactions.where(rating: user_rating).index_by(&:emoji) : {} %>
  
  <% if logged_in? %>
    <!-- Emoji Reactions Display Row -->
    <div class="flex items-center gap-2 flex-wrap">
      <!-- Show existing reactions -->
      <% ReviewReaction::ALLOWED_EMOJIS.each do |emoji| %>
        <% count = user_rating.review_reactions.where(emoji: emoji).count %>
        <% user_has_reacted = user_reactions[emoji].present? %>
        
        <% if count > 0 %>
          <%= form_with url: review_reactions_path, method: :post, local: true, class: "inline" do |f| %>
            <%= f.hidden_field :rating_id, value: user_rating.id %>
            <%= f.hidden_field :emoji, value: emoji %>
            <button type="submit" class="flex items-center gap-1 px-2 py-1 text-sm transition-all" style="border-radius: 6px; border: <%= user_has_reacted ? '2px solid rgb(59, 130, 246)' : '1px solid rgb(209, 213, 219)' %>; background: rgb(249, 250, 251);" title="<%= emoji %>">
              <span style="font-size: 1.2em;"><%= emoji %></span>
              <span class="text-xs font-semibold"><%= count %></span>
            </button>
          <% end %>
        <% end %>
      <% end %>
      
      <!-- Add emoji button wrapper for relative positioning -->
      <div class="relative inline-block">
        <button type="button" class="emoji-picker-toggle flex items-center justify-center w-8 h-8 rounded border border-gray-300 bg-gray-50 hover:bg-gray-100 transition-colors" title="Add reaction" data-rating-id="<%= user_rating.id %>">
          <span style="font-size: 1.2em;">âž•</span>
        </button>
        
        <!-- Emoji picker grid (horizontal) - positioned absolutely relative to button wrapper -->
        <div id="emoji-picker-menu-<%= user_rating.id %>" class="absolute left-0 top-full mt-2 bg-white border border-gray-300 rounded-lg shadow-lg p-2 flex gap-1 flex-wrap hidden z-[9999]" style="width: 350px;">
          <% ReviewReaction::ALLOWED_EMOJIS.each do |emoji| %>
            <% user_has_reacted = user_reactions[emoji].present? %>
            <% count = user_rating.review_reactions.where(emoji: emoji).count %>
            <%= form_with url: review_reactions_path, method: :post, local: true, class: "inline" do |f| %>
              <%= f.hidden_field :rating_id, value: user_rating.id %>
              <%= f.hidden_field :emoji, value: emoji %>
              <button type="submit" class="flex items-center justify-center gap-0.5 px-3 py-1 w-16 rounded <%= user_has_reacted ? 'bg-gray-50 border-2 border-blue-400' : 'border border-gray-300' %> hover:bg-gray-100 transition-colors" title="<%= emoji %>" style="font-size: 1.5em; min-width: 60px;">
                <%= emoji %>
                <% if count > 0 %>
                  <span class="text-xs font-semibold text-gray-600"><%= count %></span>
                <% end %>
              </button>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <!-- For unsigned users, just show reactions -->
    <div class="flex items-center gap-2 flex-wrap">
      <% ReviewReaction::ALLOWED_EMOJIS.each do |emoji| %>
        <% count = user_rating.review_reactions.where(emoji: emoji).count %>
        <% if count > 0 %>
          <div class="flex items-center gap-1 px-2 py-1 text-sm rounded bg-gray-50 border border-gray-300">
            <span style="font-size: 1.2em;"><%= emoji %></span>
            <span class="text-xs font-semibold"><%= count %></span>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>

