<main class="min-h-screen bg-neutral-25 px-6 py-12">
  <section class="mx-auto max-w-7xl">
    <header class="mb-8 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="font-display text-4xl font-semibold text-slate-900">My Library</h1>
        <p class="mt-2 text-slate-600">Your personal collection of movies to watch and favorites.</p>
      </div>
      <div class="flex gap-3">
        <%= link_to "Browse Movies", movies_path, class: "px-6 py-2 bg-brand-600 text-white font-semibold rounded-lg hover:bg-brand-700 transition" %>
        <%= link_to "Dashboard", dashboard_path, class: "px-6 py-2 bg-slate-600 text-white font-semibold rounded-lg hover:bg-slate-700 transition" %>
      </div>
    </header>

    <!-- Top 5 Movies Section -->
    <% if @top_movies.any? %>
      <section class="mb-10">
        <h2 class="text-2xl font-semibold text-slate-900 mb-4 flex items-center gap-2">
          <svg class="w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
          </svg>
          My Top 5 Movies
        </h2>
        <div class="grid gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-5">
          <% (1..5).each do |position| %>
            <% favorite = @top_movies.find { |f| f.top_position == position } %>
            <% if favorite %>
              <div class="relative rounded-xl overflow-hidden shadow-lg group">
                <div class="absolute top-2 left-2 z-10 w-8 h-8 bg-yellow-500 text-white rounded-full flex items-center justify-center font-bold text-lg shadow">
                  <%= position %>
                </div>
                <% if favorite.movie.poster_url.present? %>
                  <%= link_to movie_path(favorite.movie.tmdb_id || favorite.movie.id) do %>
                    <img src="<%= favorite.movie.poster_url %>" alt="<%= favorite.movie.title %>" class="w-full h-64 object-cover group-hover:scale-105 transition-transform duration-200">
                  <% end %>
                <% else %>
                  <div class="w-full h-64 bg-neutral-100 flex items-center justify-center">
                    <p class="text-slate-500 text-sm">No poster</p>
                  </div>
                <% end %>
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-3">
                  <p class="text-white text-sm font-medium truncate"><%= favorite.movie.title %></p>
                </div>
              </div>
            <% else %>
              <div class="rounded-xl border-2 border-dashed border-neutral-300 h-64 flex items-center justify-center">
                <div class="text-center">
                  <span class="text-3xl font-bold text-neutral-300"><%= position %></span>
                  <p class="text-sm text-neutral-400 mt-1">Empty</p>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      </section>
    <% end %>

    <% tabs = [
      { id: "watchlist", name: "Watchlist", count: @watchlists.count },
      { id: "favorites", name: "Favorites", count: @favorites.count }
    ] + @lists.map { |list| { id: "list-#{list.id}", name: list.name, count: list.list_items.size } } %>
    <% initial_tab = params[:tab].presence || "watchlist" %>

    <!-- Tabs for Watchlist, My Library, and custom lists -->
    <div class="border-b border-neutral-200 mb-6" id="tab-container" data-initial-tab="<%= initial_tab %>">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <nav class="-mb-px flex flex-wrap gap-2">
          <% tabs.each_with_index do |tab, index| %>
            <% active = initial_tab == tab[:id] || (params[:tab].blank? && index.zero?) %>
            <button data-tab-target="<%= tab[:id] %>"
                    class="tab-btn whitespace-nowrap py-4 px-3 border-b-2 font-medium text-sm transition <%= active ? 'active border-brand-500 text-brand-600' : 'border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700' %>">
              <%= tab[:name] %>
              <span class="ml-2 rounded-full bg-neutral-100 px-2.5 py-0.5 text-xs font-medium text-slate-600"><%= tab[:count] %></span>
            </button>
          <% end %>
        </nav>
        <button id="new-list-toggle" class="inline-flex items-center justify-center gap-2 rounded-lg border border-brand-200 px-4 py-2 text-sm font-semibold text-brand-700 hover:bg-brand-50 transition">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          New List
        </button>
      </div>
    </div>

    <!-- Watchlist Tab Content -->
    <div id="watchlist" class="tab-content" data-tab-content>
      <% if @watchlists.any? %>
        <%= turbo_frame_tag "library-list" do %>
          <div class="grid gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
            <% @watchlists.each do |wl| %>
              <%= turbo_frame_tag "watchlist-item-#{wl.id}" do %>
                <% movie = wl.movie %>
                <div class="rounded-2xl border border-neutral-100 bg-white overflow-hidden shadow-card hover:shadow-lg transition group">
                  <div class="relative">
                    <% if movie.poster_url.present? %>
                      <%= link_to movie_path(movie.tmdb_id || movie.id) do %>
                        <img src="<%= movie.poster_url %>" alt="<%= movie.title %>" class="w-full h-64 object-cover group-hover:scale-105 transition-transform duration-200">
                      <% end %>
                    <% else %>
                      <div class="w-full h-64 bg-neutral-100 flex items-center justify-center">
                        <p class="text-slate-500">No poster available</p>
                      </div>
                    <% end %>
                    <!-- Quick Actions Overlay -->
                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                      <%= button_to favorites_path(tmdb_id: movie.tmdb_id, title: movie.title, poster_url: movie.poster_url), method: :post, class: "p-2 bg-white rounded-full text-brand-600 hover:bg-brand-50 transition", title: "Add to My Library" do %>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                      <% end %>
                      <%= button_to watchlist_path(wl), method: :delete, data: { turbo_frame: "watchlist-item-#{wl.id}" }, class: "p-2 bg-white rounded-full text-red-600 hover:bg-red-50 transition", title: "Remove from Watchlist" do %>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                      <% end %>
                    </div>
                  </div>
                  <div class="p-4">
                    <div class="flex items-start justify-between">
                      <div class="flex-1 min-w-0">
                        <h2 class="text-lg font-semibold text-slate-900 truncate"><%= movie.title %></h2>
                        <% if movie.release_date.present? %>
                          <p class="text-sm text-slate-500 mt-1"><%= movie.release_date.strftime("%B %d, %Y") %></p>
                        <% end %>
                      </div>
                      <span class="ml-2 inline-flex items-center rounded-full bg-brand-100 px-2.5 py-0.5 text-xs font-medium text-brand-700">
                        <%= wl.status.humanize %>
                      </span>
                    </div>
                    <p class="mt-3 text-sm text-slate-700 line-clamp-2"><%= movie.description.presence || "No description available." %></p>
                    <% if movie.runtime.present? %>
                      <p class="text-sm text-slate-500 mt-1"><%= movie.runtime %> min</p>
                    <% end %>
                    <% if movie.tags.any? %>
                      <div class="flex flex-wrap gap-1 mt-3">
                        <% movie.tags.first(3).each do |tag| %>
                          <span class="inline-flex items-center rounded-full bg-neutral-100 px-2 py-0.5 text-xs font-medium text-slate-600">
                            <%= tag.name %>
                          </span>
                        <% end %>
                        <% if movie.tags.count > 3 %>
                          <span class="text-xs text-slate-400">+<%= movie.tags.count - 3 %></span>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        <% end %>
      <% else %>
        <div class="rounded-2xl border border-neutral-100 bg-white p-12 text-center shadow-card">
          <svg class="mx-auto h-12 w-12 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
          </svg>
          <h3 class="mt-4 text-lg font-medium text-slate-900">Your watchlist is empty</h3>
          <p class="mt-2 text-slate-600">Add movies you want to watch from the search results.</p>
          <%= link_to "Search Movies", movies_path, class: "inline-block mt-6 px-6 py-2 bg-brand-600 text-white font-semibold rounded-lg hover:bg-brand-700 transition" %>
        </div>
      <% end %>
    </div>

    <!-- My Library Tab Content -->
    <div id="favorites" class="tab-content hidden" data-tab-content>
      <% if @favorites.any? %>
        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          <% @favorites.each do |favorite| %>
            <% movie = favorite.movie %>
            <div class="rounded-2xl border border-neutral-100 bg-white overflow-hidden shadow-card hover:shadow-lg transition group">
              <div class="relative">
                <% if movie.poster_url.present? %>
                  <%= link_to movie_path(movie.tmdb_id || movie.id) do %>
                    <img src="<%= movie.poster_url %>" alt="<%= movie.title %>" class="w-full h-64 object-cover group-hover:scale-105 transition-transform duration-200">
                  <% end %>
                <% else %>
                  <div class="w-full h-64 bg-neutral-100 flex items-center justify-center">
                    <p class="text-slate-500">No poster available</p>
                  </div>
                <% end %>
                <% if favorite.top_position.present? %>
                  <div class="absolute top-2 left-2 w-8 h-8 bg-yellow-500 text-white rounded-full flex items-center justify-center font-bold text-sm shadow">
                    #<%= favorite.top_position %>
                  </div>
                <% end %>
                <div class="absolute top-2 right-2">
                  <svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>
                  </svg>
                </div>
              </div>
              <div class="p-4">
                <h2 class="text-lg font-semibold text-slate-900 truncate"><%= movie.title %></h2>
                <% if movie.release_date.present? %>
                  <p class="text-sm text-slate-500 mt-1">Released <%= movie.release_date.strftime("%B %d, %Y") %></p>
                <% end %>
                <div class="flex gap-2 mt-4 pt-4 border-t border-neutral-100">
                  <%= link_to "View details", movie_path(movie.tmdb_id || movie.id), class: "flex-1 text-center px-3 py-2 text-sm bg-neutral-50 text-slate-700 font-medium rounded-lg hover:bg-neutral-100 transition" %>
                  <%= button_to "Remove", favorite_path(favorite), method: :delete, class: "flex-1 text-center px-3 py-2 text-sm bg-red-50 text-red-700 font-medium rounded-lg hover:bg-red-100 transition" %>
                </div>
                <% if favorite.top_position.nil? %>
                  <div class="mt-3 pt-3 border-t border-neutral-100">
                    <p class="text-xs text-slate-500 mb-2">Add to Top 5:</p>
                    <div class="flex gap-1">
                      <% (1..5).each do |pos| %>
                        <% existing = @top_movies.find { |f| f.top_position == pos } %>
                        <button
                          onclick="setTopPosition(<%= favorite.id %>, <%= pos %>)"
                          class="w-8 h-8 rounded-full text-sm font-medium <%= existing ? 'bg-slate-200 text-slate-400' : 'bg-brand-100 text-brand-700 hover:bg-brand-200' %> transition"
                          <%= 'title="Position taken by ' + existing.movie.title + '"' if existing %>
                        >
                          <%= pos %>
                        </button>
                      <% end %>
                    </div>
                  </div>
                <% else %>
                  <div class="mt-3 pt-3 border-t border-neutral-100">
                    <button
                      onclick="removeTopPosition(<%= favorite.id %>)"
                      class="text-xs text-slate-500 hover:text-red-600 transition"
                    >
                      Remove from Top 5
                    </button>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="rounded-2xl border border-neutral-100 bg-white p-12 text-center shadow-card">
          <svg class="mx-auto h-12 w-12 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
          </svg>
          <h3 class="mt-4 text-lg font-medium text-slate-900">No favorites yet</h3>
          <p class="mt-2 text-slate-600">Mark movies you love to see them here.</p>
          <%= link_to "Search Movies", movies_path, class: "inline-block mt-6 px-6 py-2 bg-brand-600 text-white font-semibold rounded-lg hover:bg-brand-700 transition" %>
        </div>
      <% end %>
    </div>

    <!-- Custom Lists Content -->
    <% @lists.each do |list| %>
      <div id="list-<%= list.id %>" class="tab-content hidden" data-tab-content>
        <div class="flex items-start justify-between mb-4">
          <div>
            <h2 class="text-xl font-semibold text-slate-900"><%= list.name %></h2>
            <% if list.description.present? %>
              <p class="text-slate-600 mt-1"><%= list.description %></p>
            <% end %>
          </div>
        </div>

        <% if list.list_items.any? %>
          <div class="grid gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
            <% list.list_items.each do |item| %>
              <% movie = item.movie %>
              <div class="rounded-2xl border border-neutral-100 bg-white overflow-hidden shadow-card hover:shadow-lg transition group">
                <div class="relative">
                  <% if movie.poster_url.present? %>
                    <%= link_to movie_path(movie.tmdb_id || movie.id) do %>
                      <img src="<%= movie.poster_url %>" alt="<%= movie.title %>" class="w-full h-64 object-cover group-hover:scale-105 transition-transform duration-200">
                    <% end %>
                  <% else %>
                    <div class="w-full h-64 bg-neutral-100 flex items-center justify-center">
                      <p class="text-slate-500">No poster available</p>
                    </div>
                  <% end %>
                </div>
                <div class="p-4">
                  <h3 class="text-lg font-semibold text-slate-900 truncate"><%= movie.title %></h3>
                  <% if movie.release_date.present? %>
                    <p class="text-sm text-slate-500 mt-1">Released <%= movie.release_date.strftime("%B %d, %Y") %></p>
                  <% end %>
                  <p class="mt-3 text-sm text-slate-700 line-clamp-2"><%= movie.description.presence || "No description available." %></p>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="rounded-2xl border border-neutral-100 bg-white p-8 text-center shadow-card">
            <p class="text-slate-600">No movies added yet. Create a new list with movies using the button above.</p>
          </div>
        <% end %>

        <div class="mt-6 flex justify-end">
          <%= button_to "Delete list", list_path(list), method: :delete, data: { confirm: "Are you sure you want to delete this list?" }, class: "inline-flex items-center gap-2 rounded-lg border border-red-200 px-4 py-2 text-sm font-semibold text-red-700 hover:bg-red-50 transition" %>
        </div>
      </div>
    <% end %>

    <div id="new-list-modal" class="hidden fixed inset-0 z-50 flex items-start justify-center bg-black/40 backdrop-blur-sm px-4 py-10">
      <div class="relative w-full max-w-4xl overflow-hidden rounded-2xl border border-brand-100 bg-white shadow-2xl">
        <div class="flex items-center justify-between border-b border-neutral-100 px-6 py-4">
          <div class="flex items-center gap-2">
            <svg class="h-5 w-5 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            <h3 class="text-lg font-semibold text-slate-900">Create a new list</h3>
          </div>
          <button id="new-list-close" type="button" class="rounded-full p-2 text-slate-500 hover:bg-neutral-100 focus:outline-none">
            <span class="sr-only">Close</span>
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <div class="max-h-[75vh] overflow-y-auto px-6 py-5">
          <%= form_with model: List.new, url: lists_path, method: :post, local: true do |f| %>
            <div class="grid gap-4 md:grid-cols-2">
              <div>
                <%= f.label :name, "Name", class: "block text-sm font-medium text-slate-700" %>
                <%= f.text_field :name, required: true, class: "mt-1 w-full rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm focus:border-brand-500 focus:ring-brand-500" %>
              </div>
              <div>
                <%= f.label :description, "Description", class: "block text-sm font-medium text-slate-700" %>
                <%= f.text_field :description, class: "mt-1 w-full rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm focus:border-brand-500 focus:ring-brand-500" %>
              </div>
            </div>

            <div class="mt-6">
              <label class="block text-sm font-medium text-slate-700">Search to add movies</label>
              <input id="list-movie-search" type="text" placeholder="Search for movies..." class="mt-1 w-full rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm focus:border-brand-500 focus:ring-brand-500">
              <p class="mt-1 text-xs text-slate-500">Results are fetched from TMDB. Select movies to include in your list.</p>
              <div id="list-search-results" class="mt-4 grid gap-3 md:grid-cols-2 lg:grid-cols-3 min-h-[160px] transition-opacity"></div>
            </div>

            <div class="mt-6">
              <h4 class="text-sm font-semibold text-slate-800">Selected movies</h4>
              <div id="selected-movies" class="mt-2 flex flex-wrap gap-2"></div>
              <div id="selected-movie-inputs"></div>
            </div>

            <div class="mt-6 flex justify-end gap-2 border-t border-neutral-100 pt-4">
              <button type="button" id="new-list-cancel" class="rounded-lg border border-neutral-200 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-neutral-50">Cancel</button>
              <%= f.submit "Create list", class: "inline-flex items-center justify-center rounded-lg bg-brand-600 px-4 py-2 text-sm font-semibold text-white hover:bg-brand-700 transition" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  function initLibraryPage() {
    if (document.body.dataset.libraryPageInitialized === 'true') return;
    document.body.dataset.libraryPageInitialized = 'true';

    const tabButtons = document.querySelectorAll('[data-tab-target]');
    const tabContents = document.querySelectorAll('[data-tab-content]');
    const tabContainer = document.getElementById('tab-container');
    const initialTab = tabContainer?.dataset.initialTab || (tabButtons[0]?.dataset.tabTarget);

    function activateTab(tabId) {
      tabButtons.forEach((btn) => {
        const isActive = btn.dataset.tabTarget === tabId;
        btn.classList.toggle('active', isActive);
        btn.classList.toggle('border-brand-500', isActive);
        btn.classList.toggle('text-brand-600', isActive);
        btn.classList.toggle('border-transparent', !isActive);
        btn.classList.toggle('text-slate-500', !isActive);
      });

      tabContents.forEach((content) => {
        content.classList.toggle('hidden', content.id !== tabId);
      });
    }

    tabButtons.forEach((btn) => {
      btn.addEventListener('click', () => activateTab(btn.dataset.tabTarget));
    });

    if (initialTab) {
      activateTab(initialTab);
    }

    const newListToggle = document.getElementById('new-list-toggle');
    const newListModal = document.getElementById('new-list-modal');
    const newListClose = document.getElementById('new-list-close');
    const newListCancel = document.getElementById('new-list-cancel');

    function openModal() {
      newListModal?.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
    }

    function closeModal() {
      newListModal?.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
    }

    newListToggle?.addEventListener('click', openModal);
    newListClose?.addEventListener('click', closeModal);
    newListCancel?.addEventListener('click', closeModal);

    newListModal?.addEventListener('click', (event) => {
      if (event.target === newListModal) {
        closeModal();
      }
    });

    const searchInput = document.getElementById('list-movie-search');
    const resultsContainer = document.getElementById('list-search-results');
    const selectedContainer = document.getElementById('selected-movies');
    const selectedInputs = document.getElementById('selected-movie-inputs');
    const selectedMovies = [];
    const buttonBaseClasses = 'mt-auto inline-flex items-center gap-2 self-start rounded-lg px-3 py-2 text-xs font-semibold transition';
    const activeButtonClasses = 'bg-brand-600 text-white hover:bg-brand-700';
    const disabledButtonClasses = 'bg-neutral-200 text-slate-500 cursor-not-allowed';
    let searchTimeout;
    let isSearching = false;

    function renderSelectedMovies() {
      selectedContainer.innerHTML = '';
      selectedInputs.innerHTML = '';

      selectedMovies.forEach((movie) => {
        const pill = document.createElement('span');
        pill.className = 'inline-flex items-center gap-2 rounded-full bg-brand-50 px-3 py-1 text-sm font-medium text-brand-700';
        pill.innerHTML = `${movie.title || 'Untitled'} <button type="button" class="text-xs text-red-600" aria-label="Remove">Ã—</button>`;
        pill.querySelector('button').addEventListener('click', () => removeMovie(movie.tmdb_id));
        selectedContainer.appendChild(pill);

        const tmdbInput = document.createElement('input');
        tmdbInput.type = 'hidden';
        tmdbInput.name = 'movies[][tmdb_id]';
        tmdbInput.value = movie.tmdb_id;
        selectedInputs.appendChild(tmdbInput);

        const titleInput = document.createElement('input');
        titleInput.type = 'hidden';
        titleInput.name = 'movies[][title]';
        titleInput.value = movie.title;
        selectedInputs.appendChild(titleInput);

        const posterInput = document.createElement('input');
        posterInput.type = 'hidden';
        posterInput.name = 'movies[][poster_url]';
        posterInput.value = movie.poster_url || '';
        selectedInputs.appendChild(posterInput);

        const releaseInput = document.createElement('input');
        releaseInput.type = 'hidden';
        releaseInput.name = 'movies[][release_date]';
        releaseInput.value = movie.release_date || '';
        selectedInputs.appendChild(releaseInput);
      });
    }

    function isMovieSelected(tmdbId) {
      return selectedMovies.some((m) => String(m.tmdb_id) === String(tmdbId));
    }

    function setButtonState(button, selected) {
      button.className = `${buttonBaseClasses} ${selected ? disabledButtonClasses : activeButtonClasses}`;
      button.textContent = selected ? 'Added' : 'Add to list';
      button.disabled = selected;
    }

    function addMovie(movie, actionButton) {
      if (selectedMovies.some((m) => m.tmdb_id === movie.tmdb_id)) return;
      selectedMovies.push(movie);
      renderSelectedMovies();

      if (actionButton) {
        setButtonState(actionButton, true);
      }
    }

    function removeMovie(tmdbId) {
      const index = selectedMovies.findIndex((m) => m.tmdb_id === tmdbId);
      if (index !== -1) {
        selectedMovies.splice(index, 1);
        renderSelectedMovies();

        document.querySelectorAll(`[data-movie-id="${tmdbId}"]`).forEach((button) => {
          setButtonState(button, false);
        });
      }
    }

    function renderResults(movies) {
      resultsContainer.innerHTML = '';
      resultsContainer.classList.remove('opacity-50');

      if (!movies.length) {
        resultsContainer.innerHTML = '<p class="text-sm text-slate-500">No movies found.</p>';
        return;
      }

      movies.forEach((movie) => {
        const card = document.createElement('div');
        card.className = 'flex gap-3 rounded-xl border border-neutral-200 bg-white p-3 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md';

        const posterWrapper = document.createElement('div');
        posterWrapper.className = 'h-20 w-14 overflow-hidden rounded-lg bg-neutral-100 flex-shrink-0';
        if (movie.poster_url) {
          const poster = document.createElement('img');
          poster.src = movie.poster_url;
          poster.alt = movie.title || 'Poster';
          poster.className = 'h-full w-full object-cover';
          posterWrapper.appendChild(poster);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'flex h-full w-full items-center justify-center text-xs text-slate-400';
          placeholder.textContent = 'No poster';
          posterWrapper.appendChild(placeholder);
        }
        card.appendChild(posterWrapper);

        const details = document.createElement('div');
        details.className = 'flex flex-1 flex-col gap-1';

        const title = document.createElement('h4');
        title.className = 'text-sm font-semibold text-slate-900 line-clamp-2';
        title.textContent = movie.title || 'Untitled';
        details.appendChild(title);

        if (movie.release_date) {
          const meta = document.createElement('p');
          meta.className = 'text-xs text-slate-500';
          meta.textContent = `Released ${movie.release_date}`;
          details.appendChild(meta);
        }

        const action = document.createElement('button');
        action.type = 'button';
        action.dataset.movieId = movie.tmdb_id;
        setButtonState(action, isMovieSelected(movie.tmdb_id));
        action.addEventListener('click', () => addMovie(movie, action));
        details.appendChild(action);

        card.appendChild(details);
        resultsContainer.appendChild(card);
      });
    }

    async function searchMovies(query) {
      isSearching = true;
      resultsContainer.classList.add('opacity-50');
      resultsContainer.innerHTML = '<p class="text-sm text-slate-500">Searching...</p>';

      try {
        const response = await fetch(`/movies.json?search=${encodeURIComponent(query)}`);
        const data = await response.json();
        const movies = data.movies || [];
        renderResults(movies);
      } catch (error) {
        console.error('Search error', error);
        resultsContainer.innerHTML = '<p class="text-sm text-red-600">Unable to search for movies right now.</p>';
      } finally {
        isSearching = false;
      }
    }

    if (searchInput && resultsContainer) {
      searchInput.addEventListener('input', (event) => {
        const query = event.target.value.trim();

        clearTimeout(searchTimeout);

        if (query.length < 2) {
          resultsContainer.innerHTML = '';
          return;
        }

        searchTimeout = setTimeout(() => searchMovies(query), 300);
      });
    }
  }

  async function setTopPosition(favoriteId, position) {
    try {
      const response = await fetch(`/favorites/${favoriteId}/set_top_position`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ position: position })
      });

      if (response.ok) {
        window.location.reload();
      } else {
        const data = await response.json();
        alert(data.error || 'Failed to set position');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred');
    }
  }

  async function removeTopPosition(favoriteId) {
    try {
      const response = await fetch(`/favorites/${favoriteId}/remove_top_position`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        }
      });

      if (response.ok) {
        window.location.reload();
      } else {
        const data = await response.json();
        alert(data.error || 'Failed to remove position');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred');
    }
  }

  document.addEventListener('turbo:load', initLibraryPage);
  document.addEventListener('DOMContentLoaded', initLibraryPage);
</script>
