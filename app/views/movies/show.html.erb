<main class="min-h-screen bg-neutral-25 px-6 py-12">
  <section class="mx-auto max-w-4xl space-y-8 rounded-3xl border border-neutral-100 bg-white/90 p-8 shadow-card backdrop-blur">
    <header class="flex flex-col gap-6 md:flex-row md:items-center md:gap-8">
      <%= image_tag poster_url(@movie["poster_path"], size: "w342"), alt: @movie["title"], class: "h-72 w-48 rounded-2xl object-cover shadow-md" %>
      <div class="space-y-2">
        <p class="badge bg-brand-50 text-brand-700 ring-brand-100">Movie Details</p>
        <h1 class="font-display text-3xl font-semibold text-slate-900"><%= @movie["title"] %></h1>
        <p class="text-slate-700">Released: <%= release_year(@movie) %></p>
        <% if @movie["tagline"].present? %>
          <p class="italic text-slate-600">“<%= @movie["tagline"] %>”</p>
        <% end %>
      </div>
    </header>

    <div class="space-y-4">
      <h2 class="text-xl font-semibold text-slate-900">Overview</h2>
      <p class="text-slate-700 leading-relaxed"><%= @movie["overview"].presence || "No overview available." %></p>
    </div>

    <div class="grid gap-4 md:grid-cols-2">
      <div class="rounded-2xl border border-neutral-100 bg-white p-4 shadow-sm">
        <h3 class="text-lg font-semibold text-slate-900">Quick facts</h3>
        <dl class="mt-2 space-y-2 text-slate-700">
          <div class="flex justify-between">
            <dt>Director</dt>
            <dd><%= director_name(@movie) %></dd>
          </div>
          <div class="flex justify-between">
            <dt>Runtime</dt>
            <dd><%= @movie["runtime"].present? ? "#{@movie["runtime"]} mins" : "N/A" %></dd>
          </div>
          <div class="flex justify-between">
            <dt>User score</dt>
            <dd><%= @movie["vote_average"].present? ? sprintf("%.1f/10", @movie["vote_average"]) : "N/A" %></dd>
          </div>
          <div class="flex justify-between">
            <dt>TMDB ID</dt>
            <dd><%= @movie["id"] %></dd>
          </div>
        </dl>
      </div>
      <div class="rounded-2xl border border-neutral-100 bg-white p-4 shadow-sm">
        <h3 class="text-lg font-semibold text-slate-900">Your Rating</h3>
        <% if logged_in? %>
          <% movie_record = Movie.find_by(tmdb_id: @movie["id"]) || Movie.create!(
            title: @movie["title"],
            tmdb_id: @movie["id"],
            poster_url: @movie["poster_path"],
            description: @movie["overview"],
            vote_average: @movie["vote_average"],
            vote_count: @movie["vote_count"],
            release_date: @movie["release_date"].present? ? Date.parse(@movie["release_date"]) : nil,
            runtime: @movie["runtime"],
            genres: @movie["genres"]&.map { |g| g["name"] }&.to_json,
            director: director_name(@movie),
            cast: @movie["cast"]&.to_json
          ) %>
          <div class="mt-2">
            <%= render "ratings/star_rating", movie: movie_record, show_form: true %>
          </div>
        <% else %>
          <p class="mt-2 text-sm text-slate-600"><%= link_to "Sign in", sign_in_path, class: "text-blue-600 hover:underline" %> to rate this movie.</p>
        <% end %>
      </div>
    </div>

    <div class="flex flex-col gap-4 sm:flex-row sm:justify-between sm:items-center">
      <% if logged_in? %>
        <div class="flex gap-3">
          <%= link_to "Add to Favorites", new_diary_entry_path(movie_id: @movie["id"]), class: "px-4 py-2 bg-brand-600 text-white font-semibold rounded-lg hover:bg-brand-700 transition" %>
          <%= form_with url: watchlists_path, method: :post, local: true, class: "inline" do |f| %>
            <%= f.hidden_field :tmdb_id, value: @movie["id"] %>
            <%= f.hidden_field :title, value: @movie["title"] %>
            <%= f.hidden_field :poster_url, value: poster_url(@movie["poster_path"], size: "w342") %>
            <%= f.submit "Add to Watchlist", class: "px-4 py-2 bg-neutral-200 text-slate-900 font-semibold rounded-lg hover:bg-neutral-300 transition" %>
          <% end %>
        </div>
      <% else %>
        <p class="text-slate-600"><%= link_to "Sign in", sign_in_path, class: "text-brand-600 font-semibold hover:text-brand-700" %> to add to favorites</p>
      <% end %>
      <div class="text-right">
        <%= link_to "Back to search", movies_path(query: @movie["title"]), class: "text-brand-600 font-semibold hover:text-brand-700" %>
      </div>
    </div>
  </section>
</main>
